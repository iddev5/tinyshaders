<!DOCTYPE html>
<html>
  <head>
    <title>Tiny Shaders</title>

    <style>
      body {
        color: white;
        background: black;
      }

      .back-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 50%;
        z-index: -1;
        background-color: yellow;
      }
      .img {
        position: absolute;
        width: 100%;
        height: 100px;
        left: 0px;
        top: 50%;
        z-index: -1;
        background-image: url("assets/wave.svg");
        background-repeat: repeat-x;
        background-size: 200px 100px;
        filter: invert(98%) sepia(99%) saturate(7496%) hue-rotate(353deg)
          brightness(106%) contrast(108%);
      }

      .page {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .main {
        display: flex;
        justify-content: center;
        margin-top: 5%;
        padding: 10px;
        background-color: grey;
        border-radius: 20px;
      }

      #code {
        padding-left: 35px;
      }

      .line-numbers {
        margin-left: 4px;
        margin-top: 10px;
        font-size: 0.75em;
        position: absolute;
        width: 20px;
        text-align: right;
        height: 100px;
      }

      .line-numbers span {
        counter-increment: linenumber;
      }

      .line-numbers span::before {
        content: counter(linenumber);
        display: block;
        color: white;
      }

      @keyframes move {
        from {
          transform: translateY(0) rotate(45deg);
        }
        to {
          transform: translateY(45px) rotate(45deg);
        }
      }

      @keyframes opacity {
        from {
          opacity: 0%;
        }
        50% {
          opacity: 100%;
        }
        to {
          opacity: 0%;
        }
      }

      .arrow-block {
        display: inline;
      }

      .arrow {
        opacity: 0%;
        position: absolute;
        border: solid white;
        border-width: 0 3px 3px 0;
        display: block;
        padding: 12px;
        animation: opacity 1.5s infinite, move 1.5s infinite;
      }
      .arrow2 {
        animation-delay: 0.5s;
      }
      .arrow3 {
        animation-delay: 1s;
      }

      .samples {
        margin-top: 7%;
        display: grid;
        gap: 50px;
        grid-template-columns: auto auto auto;
      }

      .sample {
        align-items: center;
        padding: 20px;
        background-color: grey;
        border-radius: 10px;
      }

      .sample a {
        display: block;
        text-align: center;
        text-decoration: none;
        color: cyan;
      }

      canvas,
      form {
        margin: 10px;
      }

      textarea {
        color: white;
        background-color: black;
        padding: 10px;
        border: 0;
      }
    </style>
  </head>
  <body>
    <div class="back-top"></div>
    <div class="img"></div>

    <div class="page">
      <div class="main">
        <canvas id="webgl" width="600" height="400"></canvas>
        <form id="codeform">
          <div class="line-numbers">
            <span></span>
          </div>
          <textarea id="code" rows="20" cols="75"></textarea>
          <div>
            <input type="submit" value="Run Shader" />
            <button id="screenshot">Screenshot</button>
          </div>
        </form>
      </div>

      <h1>Samples</h1>
      <span class="arrow-block">
        <i class="arrow"></i>
        <i class="arrow arrow2"></i>
        <i class="arrow arrow3"></i>
      </span>

      <div class="samples"></div>
    </div>

    <script lang="js">
      const sampleList = ["rainbow", "mouse", "mandelbrot", "random"];

      function sample(name) {
        switch (name) {
          case "rainbow":
            return "void shader(in vec3 Coord) {\n" +
              "  vec2 uv = Coord.xy / Resolution;\n" +
              "  Color = 0.5 + 0.5 * vec4(cos(Time + uv.xyx + vec3(0, 2, 4)), 1.0);\n" +
              "}\n";
            break;
          case "mouse":
            return "void shader(in vec3 Coord) {\n" +
              "vec2 uv = Coord.xy / Resolution;\n" +
              "Color = 0.5 + 0.5 * vec4(cos(MouseState.zzz + uv.xyx + vec3(0, 2, 4)), 1.0);\n" +
              "}\n";
            break;
          case "mandelbrot":
            return "void shader(in vec3 Coord) {\n" +
              "  vec2 uv = Coord.xy / Resolution * 2.0;\n\n" +

              "  float real = uv.x - 1.5;\n" +
              "  float imaginary = uv.y - 1.0;\n\n" +

              "  vec2 coord = vec2(real, imaginary);\n"+
              "  vec2 init = coord;\n\n"+

              "  for (float iter = 0.0; iter < 1000.0; ++iter) {\n"+
              "    coord = vec2(\n"+
              "      coord.x * coord.x - coord.y * coord.y,\n"+
              "      2.0 * coord.x * coord.y)\n"+
              "      + init;\n"+
              "  }\n\n"+

              "  float l = length(coord);\n"+
              "  if (l < 4.0) l = 0.0;\n"+
              "  else l = 1.0;\n\n"+

              "  Color = vec4(l, l, l, 1.0);\n"+
              "}\n";
            case "random":
              return "// https://stackoverflow.com/questions/12964279/whats-the-origin-of-this-glsl-rand-one-liner\n" +
                "float rand(vec2 co) {\n" +
                "  return fract(sin(dot(co ,vec2(12.9898, 78.233))) * 43758.5453);\n" +
                "}\n\n" +

                "void shader(in vec3 Coord) {\n" +
                "  vec2 uv = Coord.xy / Resolution;\n" +
                "  float val = rand(uv + Time * 0.5);\n" +
                "  Color = vec4(vec3(val), 1.0);\n" +
                "}\n";
                break;
        }
      }

      function createSample(samples, sampleName) {
        const sample = document.createElement("div");
        sample.classList.add("sample");

        const img =document.createElement("img");
        img.src = `assets/${sampleName}.jpg`;
        img.width = 200;
        img.height = 200;

        const a = document.createElement("a");
        a.href = `?name=${sampleName}`;
        a.innerHTML = sampleName[0].toUpperCase() + sampleName.slice(1);

        sample.appendChild(img);
        sample.appendChild(a);

        samples.appendChild(sample);
      }

      const samples = document.querySelector(".samples");
      sampleList.forEach(sampleName => createSample(samples, sampleName));

      const codearea = document.getElementById("code");
      const sample_name = new URL(window.location.href).searchParams;
      code.value = sample(sample_name.get("name") ?? "rainbow");

      const lines = document.querySelector(".line-numbers");
      createLines(codearea);

      codearea.addEventListener("keyup", event => createLines(event.target));

      function createLines(target) {
        const num = target.value.split("\n").length;
        lines.innerHTML = Array(num).fill("<span></span>").join("");
      }

      const canvas = document.querySelector("#webgl");
      const gl = canvas.getContext("webgl2", { preserveDrawingBuffer: true});

      if (gl === null) {
        console.error("WebGL not found!")
      }

      document.getElementById("screenshot").addEventListener("click", event => {
        event.preventDefault();

        const image_data = canvas.toDataURL("image/jpeg");

        const a = document.createElement("a");
        a.download = "screenshot.jpg";
        a.href = image_data;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      gl.viewport(0, 0, canvas.width, canvas.height);

      gl.clearColor(0.0, 0.0, 0.0, 1.0);
      gl.clear(gl.COLOR_BUFFER_BIT);

      const pos=[1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, -1.0, -1.0];
      const vertices = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, vertices);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(pos), gl.STATIC_DRAW);

      document.getElementById("codeform").addEventListener("submit", runShader);

      let frame = null;
      runShader(new Event(0));

      function runShader(ev) {
        ev.preventDefault();

        const vertex_source = `#version 300 es
        in vec2 pos;
        void main() {
          gl_Position = vec4(pos, 0.0, 1.0);
        }
        `;

        const frag_header = `#version 300 es
        precision highp float;

        uniform float Time;
        uniform float TimeDelta;
        uniform float FrameRate;
        uniform vec2 Resolution;
        uniform vec3 MouseState;

        out vec4 Color;

        void shader(in vec3 Coord);

        void main() {
          shader(gl_FragCoord.xyz);
        }

        `;

        const code = document.querySelector("#code").value;

        const vs = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vs, vertex_source);
        gl.compileShader(vs);

        if (!gl.getShaderParameter(vs, gl.COMPILE_STATUS)) {
          alert("Error: " + gl.getShaderInfoLog(vs));
        }

        const fs = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fs, frag_header + code);
        gl.compileShader(fs);

        if (!gl.getShaderParameter(vs, gl.COMPILE_STATUS)) {
          alert("Error: " + gl.getShaderInfoLog(vs));
        }

        const prog = gl.createProgram();
        gl.attachShader(prog, vs);
        gl.attachShader(prog, fs);
        gl.linkProgram(prog);

        if (!gl.getProgramParameter(prog, gl.LINK_STATUS)) {
          alert("Error: " + gl.getProgramInfoLog(prog));
        }

        gl.useProgram(prog);

        const initial_time = performance.now();
        let last_time = initial_time;
        let time_delta = 0;

        const pos_loc = gl.getAttribLocation(prog, "pos");
        gl.vertexAttribPointer(pos_loc, 2, gl.FLOAT, false, 0, 0);
        gl.enableVertexAttribArray(pos_loc);

        gl.uniform2f(gl.getUniformLocation(prog, "Resolution"), canvas.width, canvas.height);

        function convertXY(x, y) {
          return [(x - canvas.width/2) / (canvas.width/2),
            (canvas.height/2 - y) / (canvas.height/2)];
        }

        const handleMove = event => {
          event.preventDefault();
          gl.uniform3f(gl.getUniformLocation(prog, "MouseState"), event.clientX, ...convertXY(event.clientX, event.clientY));
        };


        const handleDown = event => {
          event.preventDefault();
          gl.uniform3f(gl.getUniformLocation(prog, "MouseState"), event.clientX, event.clientY, event.button);
        };

        canvas.removeEventListener("mousemove", handleMove);
        canvas.removeEventListener("mousedown", handleDown);

        canvas.addEventListener("mousemove", handleMove);
        canvas.addEventListener("mousedown", handleDown);

        function update() {
          const time = performance.now() - initial_time;
          time_delta = time - last_time;
          last_time = time;

          gl.uniform1f(gl.getUniformLocation(prog, "Time"), time / 1000.0);
          gl.uniform1f(gl.getUniformLocation(prog, "TimeDelta"), time_delta / 1000.0);
          gl.uniform1f(gl.getUniformLocation(prog, "FrameRate"), 1000.0 / time_delta);

          gl.drawArrays(gl.TRIANGLES, 0, 6);
          frame = requestAnimationFrame(update);
        }

        cancelAnimationFrame(frame);
        frame = requestAnimationFrame(update);
      }
    </script>
  </body>
</html>
